---
layout: post
title: 使用Git完成基本的版本控制
category: git
tags: Git 工具
author: 郑未
keywords: lanqiao 蓝桥 培训 教程 git
description: 
p_cate: 常用工具使用教程
---
  Git是目前世界上最先进的分布式版本控制系统。github是全世界最大、质量最高的代码托管平台。现如今在github上没有自己维护的项目，都不好意思和别人聊天。

  装*只是学习git的一个原因，更重要的原因是我们要维护代码的版本，并且希望网络上有一份永久的存储，这样我们可以将代码回退到任意历史版本，可以和别人协作，在切换工作环境之后可以轻易获得自己曾经写过的代码。

**获取本教程所有源码，请克隆[仓库](https://git.coding.net/lanqiao/gitdemo.git).**

>纸上得来终觉浅，绝知此事要躬行。

# 0.实验目标 #

- 搭建git环境并做基本配置
- clone远程仓库
- 维护本地仓库
- 推送变化到远程仓库
- 用辅助命令查看日志与文件状态


# 1.安装 #

各平台版本都可以从[这里](https://git-scm.com/downloads)下载，根据提示进行安装，windows下的安装非常简单。

本教程只用命令行（mac终端上工作），假如你是 Mac 用户，我们希望你懂得如何使用终端（Terminal）；假如你是 Windows 用户，我们希望你懂得如何使用命令窗口（Command Prompt）或 PowerShell（[命令行速成教程](//常用工具使用教程/cmd-quickstarted)）。 

# 2.初次运行Git前的配置

## 2.1 用户信息

当安装完 Git 应该做的第一件事就是设置你的用户名称与邮件地址。 这样做很重要，因为每一个 Git 的提交都会使用这些信息，并且它会写入到你的每一次提交中，不可更改：

```
git config --global user.name "John Doe"
git config --global user.email johndoe@example.com
```

如果使用了 `--global` 选项，那么该命令只需要运行一次，因为之后无论你在该系统上做任何事情， Git 都会使用那些信息。当你想针对特定项目使用不同的用户名称与邮件地址时，可以在那个项目目录下运行没有 `--global` 选项的命令来配置。

## 2.2 文本编辑器

既然用户信息已经设置完毕，你可以配置默认文本编辑器了，当 Git 需要你输入信息时会调用它。 如果未配置，Git 会使用操作系统默认的文本编辑器，通常是 Vim。 如果你想使用不同的文本编辑器，例如 Emacs，可以这样做：

```
git config --global core.editor emacs
```

## 2.3 检查配置信息 ##

如果想要检查你的配置，可以使用 `git config --list` 命令来列出所有 Git 当时能找到的配置。

你可以通过输入 `git config <key>`： 来检查 Git 的某一项配置,如：

```
git config user.name
```

# 3.获取 Git 仓库

## 3.1 说明
有两种取得 Git 项目仓库的方法。 第一种是在现有项目或目录下导入所有文件到 Git 中； 第二种是从一个服务器克隆一个现有的 Git 仓库。

```
# 在当前目录新建一个Git代码库
$ git init

# 新建一个目录，将其初始化为Git代码库
$ git init [project-name]

# 下载一个项目和它的整个代码历史
$ git clone [url]
```

## 3.2 clone示例库

一般来说，我们会用远程仓库来对代码进行备份，同时便于多人协作。作为实验你可以到[github](https://github.com/),[oschina](http://git.oschina.net/)或者[码市](https://coding.net/)上去注册一个帐号并建立一个远程仓库。

项目一般有公开和私有之分，由于是试验，选择公开的就好。

创建好远程仓库之后，项目界面上有该仓库的地址,如https://git.coding.net/lanqiao/gitdemo.git——这是本教程作为示例的仓库

接下来，可以回到计算机系统，用命令将其clone下来

```
git clone https://git.coding.net/lanqiao/gitdemo.git
```

![1.0](/public/img/git/1.0.png)

我们会在当前目录下得到一个gitdemo目录，查看其内的文件，只有一个.git隐藏文件夹，别的什么也没有（读者在阅读时，情况有些变化，里面可能已经有很多内容了）。

这样你就得到了一个与远程仓库一模一样的文件仓库。

## 3.3 解读

你可以认为远程库是本地库的镜像，也可以认为本地库是远程库的镜像，这两个库之间的同步需要一些命令，`clone`只是其中一个，用于**克隆**，其余命令以后再讲。

# 4.新增（修改）一些文件并跟踪

版本控制的最大作用就是记录文件的历史状态，以便随时可以回退到历史版本。如果没有版本控制，虽然编辑器都有`ctrl+z`功能，但是次数有限，且编辑器重启后，这些暂时记录就丢失了。

因此首先我们要学会如何把文件纳入版本控制之下。git中这个动作叫做**跟踪文件**。

## 4.1 跟踪文件

使用命令 `git add` 开始跟踪一个文件，或者把已跟踪的已修改的文件放到临时存储区域。这个命令有很多参数可以选择，可通过`git add --help  `来了解，不过最常用的是两种：

```
# 跟踪一个具体的文件
git add <filepath>
# 跟踪所有文件
git add .
```

现在我们在gitdemo目录下新建lesson1目录，并在其下建立1.txt文件，随意输入一些内容，然后执行：

```
git add .
```

这样，我们新增的文件就已经被跟踪了。

请记住，你工作目录下的每一个文件都不外乎这两种状态：已跟踪或未跟踪。 已跟踪的文件是指那些被纳入了版本控制的文件。工作目录中除已跟踪文件以外的所有其它文件都属于未跟踪文件（废话）。 初次克隆某个仓库的时候，工作目录中的所有文件都属于已跟踪文件，并处于未修改状态。


## 4.2 忽略某些文件

一般我们总会有些文件无需纳入 Git 的管理。 通常都是些自动生成的文件，比如日志文件，或者编译过程中创建的临时文件等。

更典型的场景是，我们获得了一份JAVA工程源码，在本地我们需要用eclipse来进行开发，eclipse会为项目生成`.classpath` `.project` `.settings`等eclipse特有的文件（夹），还会自动编译源码，产出的`.class`文件放在bin目录下。这几个文件和bin文件夹，都没必要进行控制，因为他们会自动生成，不同的开发环境和编译环境的产出并不相同，我们只需把src目录下所有东西用git管理起来就行。

在这种情况下，我们可以创建一个名为 .gitignore 的文件，列出要忽略的文件模式。 来看一个实际的例子：

```
*.class  # 忽略clsss文件

# Mobile Tools for Java (J2ME)
.mtj.tmp/

# Package Files #
*.jar   #忽略jar包
*.war
*.ear

# eclipse files #
.project
.classpath
.settings/
```

GitHub 有一个十分详细的针对数十种项目及语言的 .gitignore 文件列表，你可以在 [https://github.com/github/gitignore](https://github.com/github/gitignore) 找到它.

## 4.3 检查当前文件状态

要查看哪些文件处于什么状态，可以用 `git status` 命令。我们现在有1.txt，可以新增一个2.txt，然后运行`git status`，可以看到：

![1.4](/public/img/git/1.4.png)

`status`命令不仅列出了文件状态，还对下一步应该使用的命令给出了提示，很棒！


# 5.提交

在完成某些鼓舞人心的工作之后（如修正某个bug或完成某个页面），你想让git记住这个历史时刻，应该进行提交。

## 5.1 commit

现在我们执行：

```
git commit
```

这种方式会启动文本编辑器以便输入本次提交的说明。如果你不熟悉当前系统的文本编辑器的使用（如vi），你也可以在 `commit` 命令后添加 `-m` 选项，将提交信息与命令放在同一行，如下所示：

```
git commit -m "第一次提交1.txt"
```

因为我们只是在示范，所以注释随便写，建议正式项目中写更为具体的注释，以便大家知道你具体干了什么。

# 6 插播：重要概念

由于是写给初学者的教程，初期我们尽量回避复杂概念，但现在我们不得不引入概念，否则接下来的学习将遇到很大的困难。

## 6.1三种状态

Git 有三种状态，你的文件可能处于其中之一：**已修改（modified）**、**已暂存（staged）**和**已提交（committed）**。 

- 已修改表示修改了文件，但还没跟踪，如新增的文件和刚修改过的文件。 
- 已暂存表示对一个已修改文件的当前版本做了标记（`git add`）。
- 已提交表示数据已经**安全**地保存在本地数据库中(`git commit`)。 

由此引入 Git 项目的三个工作区域的概念：**工作目录**、**暂存区域**以及**Git仓库**。

![1.1](/public/img/git/1.1.png)

*工作目录、暂存区域以及 Git 仓库.*

- 工作目录是放在磁盘上供你使用或修改的文件及目录总和。
- 暂存区域是一个文件，缓存文件快照，有时候也被称作“索引”，不过一般说法还是叫暂存区域。
- Git仓库是 Git 用来保存项目的元数据和文件快照的地方，记录了所有历史提交。

基本的 Git 工作流程如下：

1. 在工作目录中修改文件。
2. 暂存文件（`git add`），将文件的快照放入暂存区域。
3. 提交更新(`git commit`)，找到暂存区域的文件，将快照永久性存储到 Git 仓库。

![1.2](/public/img/git/1.2.png)

需要注意的是，文件快照**必须先经过暂存区，才能到仓库区**。盘点之前的操作，1.txt经过暂存并提交，现在进入了本地仓库，但是2.txt未进行`add`操作，因此本地仓库里面其实没有2.txt的记录。

现在我们暂存并提交下2.txt：

```
git add .
git commit -m "第一次提交2.txt"
```

## 6.2提交的才是安全的

现在我们在操作系统里面删掉1.txt并尝试恢复：

```
rm 1.txt  
ll  #查看文件列表，1.txt没了
git checkout .
ll  #查看文件列表，1.txt回来了
```

`checkout命令`我们暂时不解释，这里只证明提交了就安全了，可恢复了。相比之下，如果没有提交，直接删掉文件除了从回收站找以外没别的办法，如果回收站被清空了，那就真的丢失了。

# 7 关于提交的其他命令

## 7.1跳过暂存区域直接提交

尽管使用暂存区域的方式可以精心准备要提交的细节，但有时候这么做略显繁琐。 Git 提供了一个跳过使用暂存区域的方式， 只要在提交的时候，给 `git commit` 加上 `-a` 选项，Git 就会自动把所有已经跟踪过的文件暂存起来一并提交，从而跳过 `git add` 步骤.

## 7.2 查看提交历史

在提交了若干更新，又或者克隆了某个项目之后，你也许想回顾下提交历史. 完成这个任务最简单而又有效的工具是 `git log` 命令。

在gitdemo目录下运行 `git log`，可以看到：

![1.5](/public/img/git/1.5.png)

默认不用任何参数的话，`git log` 会按提交时间列出所有的更新，最近的更新排在最上面。 正如你所看到的，这个命令会列出每个提交的 SHA-1 校验和、作者的名字和电子邮件地址、提交时间以及提交说明。

`git log` 有许多选项可以帮助你搜寻你所要找的提交， 接下来我们介绍些最常用的。

- 一个常用的选项是 `-p`，用来显示每次提交的内容差异。 你也可以加上 `-2` 来仅显示最近两次提交
- 如果你想看到每次提交的简略的统计信息，你可以使用 `--stat` 选项.
- 另外一个常用的选项是 `--pretty`。 这个选项可以指定使用不同于默认格式的方式展示提交历史。 这个选项有一些内建的子选项供你使用。 比如用 `oneline `将每个提交放在一行显示，查看的提交数很大时非常有用。 另外还有 `short`，`full` 和 `fuller` 可以用，展示的信息或多或少有些不同，请自己动手实践一下看看效果如何。

```
git log --pretty=oneline
```

## 7.3 文件对比

### 7.3.1对比工作区与暂存区 ###

```
cat 2.txt #查看2.txt的内容222
vi 2.txt  #新增一行为333
git diff -- 2.txt #比对工作区和暂存区（上次暂存）的区别
```

得到如下提示：

![1.6](/public/img/git/1.6.png)

前面是一些基本信息，文件对比细节在@@之后，+表示新增，-表示删除，行前无符号表示未改变。

### 7.3.2对比暂存区和仓库区 ###

也就是比对缓存快照和已经提交的快照

```
git diff --cached -- 2.txt
```

结果显示无差异，因为上一次缓存的都提交了，接下来这样尝试：

```
git add . #所有文件缓存快照
git diff --cached -- 2.txt  #比对2.txt的暂存快照和提交快照
```

得到的效果和上上次实验一样，因为2.txt增加一行后的快照已经暂存，但是还没提交，所以对比下，暂存快照比已提交快照多了一行。

### 7.3.3对比工作区和仓库区 ###

也就是得到自上次提交以来文件的变化，命令必须带上`commit_id`或者基于HEAD的运算（`HEAD~`是最后一个`commit_id`）：

```
git diff HEAD~ -- 2.txt
```

对比效果和上次一样，因为新增的一行就是上次提交以来的所有变化。

### 7.3.4对比两次提交之间的差异 ###

先得到历史立交记录：

```
git log --pretty=oneline

b037a33258f9582c2d70e130b62b699df7900280 删除3.txt
54da1fe001be58c7fc41f6d3aac0e35166b8cb4a 首次提交3.txt
2abf7fb7ca06bd3a3eadc85471c41a340134d249 第一次提交2.txt
976ea66c800dee7ce3c69601e31518f2ef721237 第一次提交1.txt
```

然后对比第一和第二次提交的差异：

```
git diff 976ea66c 2abf7fb7 
```

注意，这里我们使用了简写的commit_id，因为只要简写能完全标识一次提交，没有必要使用完整的commit_id，结果如下：

![1.6](/public/img/git/1.6.png)

第二次提交相对于第一次提交来说，增加了一个文件，文件里面增加了内容。

这个命令可以带上文件路径，如：`git diff 976ea66c 2abf7fb7 -- 2.txt`，当然结果是一样的，因为只有2.txt有变化。


# 8.移除文件

之前我们移除并恢复过1.txt文件，但这与“从版本库中移除文件”并不相同。要从 Git 中移除某个文件，就必须要从已跟踪文件清单中移除（确切地说，是从暂存区域移除），然后提交。 可以用 `git rm <filepath>`命令完成此项工作，并连带从工作目录中删除指定的文件，这样以后就不会出现在未跟踪文件清单中了。

如果删除之前修改过并且已经放到暂存区域的话，则必须要用强制删除选项 `-f`（译注：即 force 的首字母）。 这是一种安全特性，用于防止误删还没有添加到快照的数据，这样的数据不能被 Git 恢复。

另外一种情况是，我们想把文件从 Git 仓库中删除（亦即从暂存区域移除），但仍然希望保留在当前工作目录中。 换句话说，你想让文件保留在磁盘，但是并不想让 Git 继续跟踪。 当你忘记添加 `.gitignore` 文件，不小心把一个很大的日志文件或一堆 `.a` 这样的编译生成文件添加到暂存区时，这一做法尤其有用。 为达到这一目的，使用 `--cached` 选项：

```
cd lesson1
echo 333>3.txt
git add .
git commit -m "首次提交3.txt"
git rm --cached 3.txt
ll  #查看文件列表，3.txt还在
git status  #3.txt显示为未跟踪
#编辑.gitignore，添加3.txt
git add .
git commit -m "删除3.txt"
```

这样处理之后，3.txt仍然在本地，但是会被git忽略掉。

# 9 将本地仓库推送至远程仓库

几乎都忘了，我们本地的gitdemo是从网络克隆下来的，现在本地仓库已经有了变化，怎么备份到远程仓库呢？

```
git push
```

推送是在远程仓库建立本地仓库的副本，便于别人拉取。

如果别人将变化推送到了远程仓库，我们怎么获取这些最新的变化呢？如果本地库和远程库一样，会得到`Everything up-to-date`提示.

```
git pull
```

取是用远程仓库更新本地仓库以获得协作者推送的最新的变化。如果远端没有更新，会得到`Already up-to-date.`提示。

# 10 总结（面试题）

Q：你所熟知的git命令有哪些？分别是什么含义？

A：
使用git最常用的命令，就6个：

![1.3](/public/img/git/1.3.png)

我们已经见过这些，现在稍加总结：

- `clone`在本地得到一个远程仓库的副本，这时本地仓库和远程仓库一模一样
- `add`将文件快照缓存到**暂存区**
- `commit`将文件快照从暂存区保存到本地仓库，每次提交需要写注释，有一个提交id
- `push`将本地仓库推送至远程仓库
- `pull`我们还没用过，但是我们知道它是用远程仓库更新本地仓库以获得协作者推送的最新的变化
- `checkout`我们只知道一个用法，就是用本地仓库恢复我们的工作区为最后一次提交的状态

---

Q：我想合并现在的提交到上一次提交，怎么做？

A：用`git commit --amend`命令

---

Q：git中文件有哪三种状态，有哪三个区域，每个区域的作用是什么？用什么命令转移文件状态？

A：略。

---

Q：怎么忽略某些文件，让它们不在版本控制之中？

A：在`.gitignore`文件中描述这些文件

---

Q：操作系统中移除文件和`git rm`命令有什么区别？

A：操作系统移除，文件快照可能还在暂存区和仓库区；`git rm`不仅在系统里面删掉了文件，还将其快照移出了暂存区和仓库区。

Q：只移除快照，但保留文件，怎么做？

A：`git rm`命令带上`--cached`命令

---

Q：如何查看提交日志，怎么把每次提交信息在日志中浓缩一行？

A：`git log`命令可查看日志，带上`--pretty=oneline`可以把每次提交信息展示为一行

---

Q：如何对比工作区文件、暂存区、仓库区快照的具体差别，如何对比两次提交之间的差异？

A：`git diff`命令可以对比工作区-暂存区，带上`--cached`命令，对比暂存区-仓库区，带上`commit_id`对比工作区和仓库区，带上两个`commit_id`对比两次提交之间的差异。

---

# 11 课后练习

- 到任意一个代码托管网站创建帐号并新建项目，然后`clone`至本地，在本地尝试上述命令
- 提交代码并推送到远程仓库
- 找一个同学`clone`你的远程仓库，让他修改并尝试提交-推送，你会发现推送失败，这是因为他没有推送权限，在网站上将他添加为你这个项目的协作者，就应该可以了
- 他推送成功后，你怎么得到最新的变化呢？当然是`pull`了！赶紧试一试吧。
- 如果你没有合适的协作者，也可以一个人扮演多个角色，用别的邮箱再注册一个帐号，并尝试上面的练习

实验中可能会遇到一些问题，可以先放一放，下一章我们将探讨关于分支和远程协作有关的话题。



